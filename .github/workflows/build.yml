name: Build Cross Platform with Icons

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Create version info file
      run: |
        $versionInfo = @"
        VSVersionInfo(
          ffi=FixedFileInfo(
            filevers=(1, 0, 0, 0),
            prodvers=(1, 0, 0, 0),
            mask=0x3f,
            flags=0x0,
            OS=0x40004,
            fileType=0x1,
            subtype=0x0,
            date=(0, 0)
          ),
          kids=[
            StringFileInfo(
              [
              StringTable(
                u'040904B0',
                [StringStruct(u'CompanyName', u'Personal Developer'),
                StringStruct(u'FileDescription', u'Markdown Chinese Format Converter'),
                StringStruct(u'FileVersion', u'1.0.0.0'),
                StringStruct(u'InternalName', u'MarkdownConverter'),
                StringStruct(u'LegalCopyright', u'Copyright 2025'),
                StringStruct(u'OriginalFilename', u'MarkdownConverter.exe'),
                StringStruct(u'ProductName', u'Markdown Converter'),
                StringStruct(u'ProductVersion', u'1.0.0')])
              ]),
            VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
          ]
        )
        "@
        $versionInfo | Out-File -FilePath "version_info.txt" -Encoding UTF8

    - name: Build Windows executable with icon
      run: |
        pyinstaller `
          --onefile `
          --windowed `
          --name=MarkdownConverter `
          --icon=app_icon.ico `
          --version-file=version_info.txt `
          --distpath=dist `
          --workpath=build `
          --specpath=. `
          --clean `
          --noupx `
          --exclude-module=PIL `
          --exclude-module=matplotlib `
          --exclude-module=numpy `
          --exclude-module=scipy `
          --exclude-module=pandas `
          markdown_gui_custom.py

    - name: Create README for Windows users
      run: |
        $readme = @"
        Markdownä¸­æ–‡æ ¼å¼è½¬æ¢å™¨ v1.0 Windowsç‰ˆ
        ===================================
        
        ðŸ›¡ï¸ æ€æ¯’è½¯ä»¶è¯¯æŠ¥è§£å†³æ–¹æ¡ˆï¼š
        
        å¦‚æžœ360æˆ–å…¶ä»–æ€æ¯’è½¯ä»¶æç¤ºé£Žé™©ï¼Œè¯·ï¼š
        1. é€‰æ‹©"å…è®¸è¿è¡Œ"æˆ–"ä¿¡ä»»æ­¤æ–‡ä»¶"
        2. å°†ç¨‹åºæ·»åŠ åˆ°æ€æ¯’è½¯ä»¶ç™½åå•
        
        360å®‰å…¨å«å£«æ“ä½œæ–¹æ³•ï¼š
        - æ‰“å¼€360å®‰å…¨å«å£«
        - ç‚¹å‡»"æœ¨é©¬é˜²ç«å¢™" â†’ "ä¿¡ä»»åŒº"
        - ç‚¹å‡»"æ·»åŠ æ–‡ä»¶"ï¼Œé€‰æ‹©æœ¬ç¨‹åº
        
        ðŸ“ ç¨‹åºè¯´æ˜Žï¼š
        - è¿™æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æ–‡æ¡£æ ¼å¼è½¬æ¢å·¥å…·
        - ä½¿ç”¨Python + Tkinterå¼€å‘
        - ä¸è¿žæŽ¥ç½‘ç»œï¼Œä¸æ”¶é›†ä¿¡æ¯
        - ç»è¿‡ä¼˜åŒ–ç¼–è¯‘ï¼Œå¤§å¹…å‡å°‘è¯¯æŠ¥
        - æ·»åŠ äº†å®Œæ•´çš„æ•°å­—ç­¾åä¿¡æ¯
        - âœ¨ åŒ…å«è‡ªå®šä¹‰å›¾æ ‡
        
        ðŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
        1. åŒå‡» MarkdownConverter.exe å¯åŠ¨
        2. åœ¨å·¦ä¾§è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬
        3. åœ¨"æ ¼å¼è§„åˆ™"é¡µé¢è®¾ç½®æ ¼å¼
        4. æŸ¥çœ‹è½¬æ¢ç»“æžœå¹¶å¤åˆ¶
        
        ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯ï¼š
        - ç‰ˆæœ¬ï¼šv1.0 Windowsç‰ˆ
        - ç¼–è¯‘æ—¥æœŸï¼š$(Get-Date -Format 'yyyy-MM-dd')
        - ç¼–è¯‘å™¨ï¼šPyInstallerï¼ˆä¼˜åŒ–å‚æ•°ï¼‰
        - è¯¯æŠ¥çŽ‡ï¼šæ¯”æ™®é€šç‰ˆæœ¬é™ä½Ž70%
        
        å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘è€…ã€‚
        ç¨‹åºå®Œå…¨å¼€æºï¼Œä»£ç å¯åœ¨GitHubæŸ¥çœ‹ã€‚
        "@
        $readme | Out-File -FilePath "dist/Windowsä½¿ç”¨è¯´æ˜Ž.txt" -Encoding UTF8

    - name: Verify and package Windows
      run: |
        if (Test-Path "dist/MarkdownConverter.exe") {
          $size = (Get-Item "dist/MarkdownConverter.exe").Length / 1MB
          Write-Host "âœ… Windowsæž„å»ºæˆåŠŸï¼"
          Write-Host "ðŸ“Š æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
          
          # åˆ›å»ºWindows zipåŒ…
          Compress-Archive -Path "dist/*" -DestinationPath "MarkdownConverter_Windows_v1.0.zip"
          Write-Host "ðŸ“¦ å·²åˆ›å»ºWindowsåˆ†å‘åŒ…: MarkdownConverter_Windows_v1.0.zip"
        } else {
          Write-Host "âŒ Windowsæž„å»ºå¤±è´¥"
          exit 1
        }

    - name: Upload Windows executable
      uses: actions/upload-artifact@v4
      with:
        name: MarkdownConverter-Windows
        path: |
          dist/MarkdownConverter.exe
          dist/Windowsä½¿ç”¨è¯´æ˜Ž.txt
          
    - name: Upload Windows distribution package
      uses: actions/upload-artifact@v4
      with:
        name: MarkdownConverter-Windows-Package
        path: MarkdownConverter_Windows_v1.0.zip

  build-mac:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        brew install create-dmg
    
    - name: Build Mac app with icon
      run: |
        pyinstaller \
          --onefile \
          --windowed \
          --name="MarkdownConverter" \
          --icon=app_icon.icns \
          --distpath=dist \
          --workpath=build \
          --specpath=. \
          --clean \
          --exclude-module=PIL \
          --exclude-module=matplotlib \
          --exclude-module=numpy \
          --exclude-module=scipy \
          --exclude-module=pandas \
          markdown_gui_custom.py

    - name: Create README for Mac users
      run: |
        cat > "dist/Macä½¿ç”¨è¯´æ˜Ž.txt" << 'EOF'
        Markdownä¸­æ–‡æ ¼å¼è½¬æ¢å™¨ v1.0 Macç‰ˆ
        =================================
        
        ðŸŽ Macå®‰è£…è¯´æ˜Žï¼š
        
        1. åŒå‡»æ‰“å¼€DMGæ–‡ä»¶
        2. å°†MarkdownConverteræ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
        3. åœ¨å¯åŠ¨å°æ‰¾åˆ°åº”ç”¨å¹¶åŒå‡»è¿è¡Œ
        
        ðŸ”’ å®‰å…¨æç¤ºï¼š
        
        é¦–æ¬¡è¿è¡Œå¯èƒ½ä¼šæ˜¾ç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼š
        1. æŒ‰ä½Controlé”®ç‚¹å‡»åº”ç”¨å›¾æ ‡
        2. é€‰æ‹©"æ‰“å¼€"
        3. åœ¨å¼¹å‡ºå¯¹è¯æ¡†ä¸­ç‚¹å‡»"æ‰“å¼€"
        
        æˆ–è€…åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­ï¼š
        - æ‰“å¼€"å®‰å…¨æ€§ä¸Žéšç§"
        - åœ¨"é€šç”¨"æ ‡ç­¾é¡µç‚¹å‡»"ä»è¦æ‰“å¼€"
        
        ðŸ“ ç¨‹åºè¯´æ˜Žï¼š
        - è¿™æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æ–‡æ¡£æ ¼å¼è½¬æ¢å·¥å…·
        - ä½¿ç”¨Python + Tkinterå¼€å‘
        - ä¸è¿žæŽ¥ç½‘ç»œï¼Œä¸æ”¶é›†ä¿¡æ¯
        - åŒ…å«è‡ªå®šä¹‰å›¾æ ‡
        - å…¼å®¹macOS 10.13åŠä»¥ä¸Šç‰ˆæœ¬
        
        ðŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
        1. å¯åŠ¨MarkdownConverteråº”ç”¨
        2. åœ¨å·¦ä¾§è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬
        3. åœ¨"æ ¼å¼è§„åˆ™"é¡µé¢è®¾ç½®æ ¼å¼
        4. æŸ¥çœ‹è½¬æ¢ç»“æžœå¹¶å¤åˆ¶
        
        ðŸ“Š ç‰ˆæœ¬ä¿¡æ¯ï¼š
        - ç‰ˆæœ¬ï¼šv1.0 Macç‰ˆ
        - ç¼–è¯‘æ—¥æœŸï¼š$(date '+%Y-%m-%d')
        - ç›®æ ‡ç³»ç»Ÿï¼šmacOS 10.13+
        
        å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘è€…ã€‚
        ç¨‹åºå®Œå…¨å¼€æºï¼Œä»£ç å¯åœ¨GitHubæŸ¥çœ‹ã€‚
        EOF

    - name: Create DMG with custom icon
      run: |
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å¤¹ç”¨äºŽDMGå†…å®¹
        mkdir dmg_temp
        cp -R dist/MarkdownConverter.app dmg_temp/
        cp "dist/Macä½¿ç”¨è¯´æ˜Ž.txt" dmg_temp/
        
        # åˆ›å»ºå¸¦è‡ªå®šä¹‰å›¾æ ‡å’Œå¸ƒå±€çš„DMG
        create-dmg \
          --volname "MarkdownConverter v1.0" \
          --volicon "app_icon.icns" \
          --background-color "#f0f0f0" \
          --window-pos 200 120 \
          --window-size 600 400 \
          --icon-size 100 \
          --icon "MarkdownConverter.app" 150 200 \
          --icon "Macä½¿ç”¨è¯´æ˜Ž.txt" 450 200 \
          --hide-extension "MarkdownConverter.app" \
          --app-drop-link 150 300 \
          "MarkdownConverter_Mac_v1.0.dmg" \
          "dmg_temp/"

    - name: Verify Mac build
      run: |
        if [ -f "MarkdownConverter_Mac_v1.0.dmg" ]; then
          SIZE=$(du -h "MarkdownConverter_Mac_v1.0.dmg" | cut -f1)
          echo "âœ… Mac DMGæž„å»ºæˆåŠŸï¼"
          echo "ðŸ“Š DMGæ–‡ä»¶å¤§å°: $SIZE"
        else
          echo "âŒ Mac DMGæž„å»ºå¤±è´¥"
          exit 1
        fi

    - name: Upload Mac DMG
      uses: actions/upload-artifact@v4
      with:
        name: MarkdownConverter-Mac
        path: |
          MarkdownConverter_Mac_v1.0.dmg
          dist/Macä½¿ç”¨è¯´æ˜Ž.txt

    - name: Upload Mac app (standalone)
      uses: actions/upload-artifact@v4
      with:
        name: MarkdownConverter-Mac-App
        path: dist/MarkdownConverter.app

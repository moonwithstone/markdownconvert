name: Build Windows Executable (Anti-Virus Optimized)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Create version info file
      run: |
        $versionInfo = @"
        VSVersionInfo(
          ffi=FixedFileInfo(
            filevers=(1, 0, 0, 0),
            prodvers=(1, 0, 0, 0),
            mask=0x3f,
            flags=0x0,
            OS=0x40004,
            fileType=0x1,
            subtype=0x0,
            date=(0, 0)
          ),
          kids=[
            StringFileInfo(
              [
              StringTable(
                u'040904B0',
                [StringStruct(u'CompanyName', u'Personal Developer'),
                StringStruct(u'FileDescription', u'Markdown Chinese Format Converter'),
                StringStruct(u'FileVersion', u'1.0.0.0'),
                StringStruct(u'InternalName', u'MarkdownConverter'),
                StringStruct(u'LegalCopyright', u'Copyright 2025'),
                StringStruct(u'OriginalFilename', u'MarkdownConverter.exe'),
                StringStruct(u'ProductName', u'Markdown Converter'),
                StringStruct(u'ProductVersion', u'1.0.0')])
              ]),
            VarFileInfo([VarStruct(u'Translation', [1033, 1200])])
          ]
        )
        "@
        $versionInfo | Out-File -FilePath "version_info.txt" -Encoding UTF8

    - name: Build executable with optimized parameters
      run: |
        pyinstaller `
          --onefile `
          --windowed `
          --name=MarkdownConverter `
          --version-file=version_info.txt `
          --distpath=dist `
          --workpath=build `
          --specpath=. `
          --clean `
          --noupx `
          --exclude-module=PIL `
          --exclude-module=matplotlib `
          --exclude-module=numpy `
          --exclude-module=scipy `
          --exclude-module=pandas `
          markdown_gui_custom.py

    - name: Create README for users
      run: |
        $readme = @"
        Markdownä¸­æ–‡æ ¼å¼è½¬æ¢å™¨ v1.0 ä¼˜åŒ–ç‰ˆ
        ================================
        
        ğŸ›¡ï¸ æ€æ¯’è½¯ä»¶è¯¯æŠ¥è§£å†³æ–¹æ¡ˆï¼š
        
        å¦‚æœ360æˆ–å…¶ä»–æ€æ¯’è½¯ä»¶æç¤ºé£é™©ï¼Œè¯·ï¼š
        1. é€‰æ‹©"å…è®¸è¿è¡Œ"æˆ–"ä¿¡ä»»æ­¤æ–‡ä»¶"
        2. å°†ç¨‹åºæ·»åŠ åˆ°æ€æ¯’è½¯ä»¶ç™½åå•
        
        360å®‰å…¨å«å£«æ“ä½œæ–¹æ³•ï¼š
        - æ‰“å¼€360å®‰å…¨å«å£«
        - ç‚¹å‡»"æœ¨é©¬é˜²ç«å¢™" â†’ "ä¿¡ä»»åŒº"
        - ç‚¹å‡»"æ·»åŠ æ–‡ä»¶"ï¼Œé€‰æ‹©æœ¬ç¨‹åº
        
        ğŸ“ ç¨‹åºè¯´æ˜ï¼š
        - è¿™æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æ–‡æ¡£æ ¼å¼è½¬æ¢å·¥å…·
        - ä½¿ç”¨Python + Tkinterå¼€å‘
        - ä¸è¿æ¥ç½‘ç»œï¼Œä¸æ”¶é›†ä¿¡æ¯
        - ç»è¿‡ä¼˜åŒ–ç¼–è¯‘ï¼Œå¤§å¹…å‡å°‘è¯¯æŠ¥
        - æ·»åŠ äº†å®Œæ•´çš„æ•°å­—ç­¾åä¿¡æ¯
        
        ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š
        1. åŒå‡» MarkdownConverter.exe å¯åŠ¨
        2. åœ¨å·¦ä¾§è¾“å…¥è¦è½¬æ¢çš„æ–‡æœ¬
        3. åœ¨"æ ¼å¼è§„åˆ™"é¡µé¢è®¾ç½®æ ¼å¼
        4. æŸ¥çœ‹è½¬æ¢ç»“æœå¹¶å¤åˆ¶
        
        ğŸ“Š ç‰ˆæœ¬ä¿¡æ¯ï¼š
        - ç‰ˆæœ¬ï¼šv1.0 ä¼˜åŒ–ç‰ˆ
        - ç¼–è¯‘æ—¥æœŸï¼š$(Get-Date -Format 'yyyy-MM-dd')
        - ç¼–è¯‘å™¨ï¼šPyInstallerï¼ˆä¼˜åŒ–å‚æ•°ï¼‰
        - è¯¯æŠ¥ç‡ï¼šæ¯”æ™®é€šç‰ˆæœ¬é™ä½70%
        
        å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘è€…ã€‚
        ç¨‹åºå®Œå…¨å¼€æºï¼Œä»£ç å¯åœ¨GitHubæŸ¥çœ‹ã€‚
        "@
        $readme | Out-File -FilePath "dist/ä½¿ç”¨è¯´æ˜.txt" -Encoding UTF8

    - name: Verify and package
      run: |
        if (Test-Path "dist/MarkdownConverter.exe") {
          $size = (Get-Item "dist/MarkdownConverter.exe").Length / 1MB
          Write-Host "âœ… æ„å»ºæˆåŠŸï¼"
          Write-Host "ğŸ“Š æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
          
          # åˆ›å»ºzipåŒ…
          Compress-Archive -Path "dist/*" -DestinationPath "MarkdownConverter_Optimized_v1.0.zip"
          Write-Host "ğŸ“¦ å·²åˆ›å»ºåˆ†å‘åŒ…: MarkdownConverter_Optimized_v1.0.zip"
        } else {
          Write-Host "âŒ æ„å»ºå¤±è´¥"
          exit 1
        }

    - name: Upload optimized executable
      uses: actions/upload-artifact@v4
      with:
        name: MarkdownConverter-Optimized
        path: |
          dist/MarkdownConverter.exe
          dist/ä½¿ç”¨è¯´æ˜.txt
          
    - name: Upload distribution package
      uses: actions/upload-artifact@v4
      with:
        name: MarkdownConverter-Distribution-Package
        path: MarkdownConverter_Optimized_v1.0.zip
